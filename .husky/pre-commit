#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# 1. Check for forbidden files (temp/analysis files that should never be committed)
# EXCEPTION: SESSION_STATUS.md is allowed (tracks current state)
# NOTE: Only check added/modified files, not deleted files (--diff-filter=AM)
FORBIDDEN_PATTERNS="AUDIT_|_SUMMARY\.md|OVERNIGHT_|_FINDINGS\.md|_STATUS\.md|HANDOFF\.md|NEXT_SESSION"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=AM)

# Filter out SESSION_STATUS.md from the check (it's meant to be committed)
FORBIDDEN_FILES=$(echo "$STAGED_FILES" | grep -vE "^SESSION_STATUS\.md$" | grep -E "$FORBIDDEN_PATTERNS" || true)

if [ -n "$FORBIDDEN_FILES" ]; then
  echo "‚ùå ERROR: Attempting to commit analysis/temp files!"
  echo "   The following files should not be committed:"
  echo "$FORBIDDEN_FILES" | sed 's/^/   - /'
  echo ""
  echo "   Remove them from staging with: git reset HEAD <file>"
  exit 1
fi

# 2. Run style checks (ESLint + Prettier) on all files
echo "üìù Running ESLint + Prettier..."
npm run style

if [ $? -ne 0 ]; then
  echo "‚ùå Style checks failed! Fix errors and try again."
  exit 1
fi

# 3. Verify modular build passes
echo "üî® Verifying build..."
npm run build:esbuild

if [ $? -ne 0 ]; then
  echo "‚ùå Build failed! Fix errors and try again."
  exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
